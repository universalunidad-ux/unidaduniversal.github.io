(()=>{"use strict";if(window.__EXP_MAIN_FINAL__)return;window.__EXP_MAIN_FINAL__=1;const D=document,W=window;

/* =========================================================
   0) PARTIALS + RUTAS (GH Pages + local) + fix year
   ========================================================= */
(()=>{const a=async u=>{try{const r=await fetch(u,{method:"HEAD",cache:"no-store"});return r.ok}catch{return!1}},b=async P=>{for(const p of P)if(await a(p))return p;return P[0]},c=location.hostname.endsWith("github.io"),d=location.pathname.split("/")[1]||"",e=c&&d?"/"+d:"",f=/\/(SISTEMAS|SERVICIOS)\//i.test(location.pathname),g=f?"../":"",h=p=>{if(!p)return p;if(/^https?:\/\//i.test(p))return p;if(p.startsWith("mailto:")||p.startsWith("tel:")||p.startsWith("data:"))return p;return(c?(e+"/"+p):g+p).replace(/\/+/g,"/")},i=(root=D)=>{root.querySelectorAll(".js-abs-src[data-src]").forEach(img=>{const ds=img.getAttribute("data-src");if(!ds)return;const fin=h(ds);img.getAttribute("src")||img.setAttribute("src",fin);img.style.opacity="1"});root.querySelectorAll(".js-abs-href[data-href]").forEach(A=>{const p=A.getAttribute("data-href");if(!p)return;const[pth,hash]=p.split("#");A.href=h(pth)+(hash?"#"+hash:"")});root.querySelectorAll(".js-img[data-src]").forEach(img=>{const ds=img.getAttribute("data-src");if(!ds)return;img.getAttribute("src")||img.setAttribute("src",h(ds))});root.querySelectorAll(".js-link[data-href]").forEach(A=>{const dh=A.getAttribute("data-href");if(!dh)return;A.getAttribute("href")||A.setAttribute("href",dh)});const y=root.getElementById?.("gf-year")||D.getElementById("gf-year")||root.getElementById?.("year")||D.getElementById("year");y&&(y.textContent=new Date().getFullYear())},j=async()=>{const hp=D.getElementById("header-placeholder"),fp=D.getElementById("footer-placeholder");if(!hp&&!fp){i(D);return}const headerURL=await b([h("PARTIALS/global-header.html"),g+"PARTIALS/global-header.html","./PARTIALS/global-header.html","/PARTIALS/global-header.html"]),footerURL=await b([h("PARTIALS/global-footer.html"),g+"PARTIALS/global-footer.html","./PARTIALS/global-footer.html","/PARTIALS/global-footer.html"]);let hh="",fh="";try{const[hr,fr]=await Promise.all([hp?fetch(headerURL,{cache:"no-store"}):Promise.resolve(null),fp?fetch(footerURL,{cache:"no-store"}):Promise.resolve(null)]);hp&&hr&&hr.ok&&(hh=await hr.text());fp&&fr&&fr.ok&&(fh=await fr.text())}catch(t){console.warn("No se pudieron cargar parciales",t)}hp&&hh&&(hp.outerHTML=hh);fp&&fh&&(fp.outerHTML=fh);i(D)};const boot=()=>{j()};D.readyState==="loading"?D.addEventListener("DOMContentLoaded",boot,{once:!0}):boot();W.addEventListener("pageshow",()=>{try{i(D)}catch{}})})();

/* =========================================================
   1) UTILIDADES (sin $ / $$ conflict)
   ========================================================= */
(()=>{const m=new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN",maximumFractionDigits:0});W.$$fmt=v=>m.format(Math.round(Number(v||0)));W.Q||(W.Q=(s,ctx=D)=>ctx.querySelector(s));W.QA||(W.QA=(s,ctx=D)=>Array.from(ctx.querySelectorAll(s)))})();

/* =========================================================
   2) AÑO + BURGER
   ========================================================= */
(()=>{const y=D.getElementById("year");y&&(y.textContent=new Date().getFullYear());const b=D.getElementById("burger"),m=D.getElementById("mobileMenu");b&&m&&b.addEventListener("click",()=>m.classList.toggle("open"))})();

/* =========================================================
   9) YOUTUBE MANAGER (pause real + lazy + FIX doble-play)
   - FIX 1: si el wrapper YA tiene iframe, NO montar overlay (evita play gris+rojo)
   - FIX 2: marcar is-ready para iframes existentes (si tu CSS usa opacity)
   ========================================================= */
(()=>{if(W.__EXP_YT_MGR__)return;W.__EXP_YT_MGR__=1;W.exPlayers=W.exPlayers||[];W.pauseAllYTIframes=function(except){(W.exPlayers||[]).forEach(p=>{if(p&&p!==except&&typeof p.pauseVideo==="function")try{const s=p.getPlayerState();(s===1||s===3)&&p.pauseVideo()}catch{}})};const onState=e=>{e&&e.data===1&&W.pauseAllYTIframes(e.target)},ensureAPI=()=>{if(W.__EXP_YT_API_REQ__)return;W.__EXP_YT_API_REQ__=1;const s=D.createElement("script");s.src="https://www.youtube.com/iframe_api";D.head.appendChild(s)},registerIframe=iframe=>{if(!iframe||iframe.dataset.ytInit)return;iframe.dataset.ytInit="1";let src=iframe.src||"";src&&src.includes("enablejsapi=1")||(src+=(src.includes("?")?"&":"?")+"enablejsapi=1"),iframe.src=src;try{const p=new YT.Player(iframe,{events:{onStateChange:onState}});W.exPlayers.push(p)}catch{}},whenYT=cb=>{if(W.YT&&W.YT.Player){cb();return}ensureAPI();let t=0;const it=setInterval(()=>{t+=1;if(W.YT&&W.YT.Player){clearInterval(it);cb()}else t>80&&clearInterval(it)},100)},poster=id=>[`https://i.ytimg.com/vi/${id}/maxresdefault.jpg`,`https://i.ytimg.com/vi/${id}/sddefault.jpg`,`https://i.ytimg.com/vi/${id}/hqdefault.jpg`],markReady=(wrap,ifr)=>{try{wrap.classList.add("is-ready");ifr&&(ifr.style.opacity="1")}catch{}},mountLazy=wrap=>{if(!wrap||wrap.dataset.ytMounted)return;

  /* --- FIX DOBLE PLAY: si ya hay iframe, NO overlay --- */
  const existing=wrap.querySelector("iframe");
  if(existing){
    wrap.dataset.ytMounted="1";
    existing.addEventListener("load",()=>markReady(wrap,existing),{once:!0});
    setTimeout(()=>markReady(wrap,existing),120); /* fallback */
    whenYT(()=>registerIframe(existing));
    return;
  }

  const id=wrap.getAttribute("data-ytid");if(!id)return;wrap.dataset.ytMounted="0";
  wrap.style.position=wrap.style.position&&wrap.style.position!=="static"?wrap.style.position:"relative";
  wrap.style.overflow="hidden";wrap.style.backgroundColor="#000";
  const img=D.createElement("img");img.alt="Miniatura de video";img.loading="lazy";
  img.style.cssText="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;display:block;cursor:pointer";
  const srcs=poster(id);let k=0;const next=()=>{k<srcs.length&&(img.src=srcs[k++])};img.addEventListener("error",next);next();wrap.appendChild(img);
  const btn=D.createElement("button");btn.type="button";btn.setAttribute("aria-label","Reproducir video en YouTube");
  btn.style.cssText="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:none;background:transparent;padding:0;cursor:pointer;display:flex;align-items:center;justify-content:center";
  const ico=D.createElement("div");
  ico.innerHTML='<svg viewBox="0 0 68 48" width="68" height="48" aria-hidden="true"><rect x="1" y="7" width="66" height="36" rx="12" fill="#FF0000"></rect><polygon points="28,17 28,31 42,24" fill="#FFFFFF"></polygon></svg>';
  btn.appendChild(ico);wrap.appendChild(btn);
  btn.addEventListener("mouseenter",()=>{ico.style.transform="scale(1.08)";ico.style.transition="transform .15s ease-out"});
  btn.addEventListener("mouseleave",()=>{ico.style.transform="scale(1)"});

  const load=()=>{if(wrap.dataset.ytMounted==="1")return;wrap.dataset.ytMounted="1";W.pauseAllYTIframes();wrap.innerHTML="";
    const ifr=D.createElement("iframe");ifr.loading="lazy";
    ifr.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
    ifr.allowFullscreen=!0;ifr.title=wrap.getAttribute("data-title")||"YouTube video";
    ifr.src=`https://www.youtube-nocookie.com/embed/${id}?rel=0&modestbranding=1&playsinline=1&autoplay=1&enablejsapi=1`;
    wrap.appendChild(ifr);
    ifr.addEventListener("load",()=>markReady(wrap,ifr),{once:!0});
    setTimeout(()=>markReady(wrap,ifr),200); /* fallback */
    whenYT(()=>registerIframe(ifr));
  };
  btn.addEventListener("click",load);img.addEventListener("click",load);
},init=()=>{

  /* 1) Lazy wrappers (solo si NO traen iframe) */
  D.querySelectorAll(".yt-wrap[data-ytid],.reel-embed[data-ytid]").forEach(mountLazy);

  /* 2) Iframes ya existentes: asegurar visible + registrar */
  D.querySelectorAll('iframe[src*="youtube"],iframe[src*="youtube-nocookie"]').forEach(ifr=>{
    const wrap=ifr.closest(".yt-wrap,.reel-embed");
    wrap&&(ifr.addEventListener("load",()=>markReady(wrap,ifr),{once:!0}),setTimeout(()=>markReady(wrap,ifr),120));
    whenYT(()=>registerIframe(ifr));
  });
};

W.onYouTubeIframeAPIReady=function(){D.querySelectorAll('iframe[src*="youtube"],iframe[src*="youtube-nocookie"]').forEach(registerIframe)};
D.readyState==="loading"?D.addEventListener("DOMContentLoaded",init,{once:!0}):init();
})();

/* =========================================================
   3) CARRUSEL UNIVERSAL (.carousel)
   ========================================================= */
(()=>{const pause=()=>{W.pauseAllYTIframes&&W.pauseAllYTIframes()},syncDots=(root,len)=>{const nav=root.querySelector(".carousel-nav");if(!nav)return[];let dots=Array.from(nav.querySelectorAll(".dot"));for(;dots.length<len;){const b=D.createElement("button");b.type="button";b.className="dot";b.setAttribute("aria-label",`Ir al reel ${dots.length+1}`);nav.appendChild(b);dots.push(b)}for(;dots.length>len;){const x=dots.pop();x&&x.remove()}return dots},hide=(root,len)=>{const prev=root.querySelector(".arrowCircle.prev"),next=root.querySelector(".arrowCircle.next"),nav=root.querySelector(".carousel-nav"),single=len<=1;prev&&(prev.disabled=single,prev.style.display=single?"none":"");next&&(next.disabled=single,next.style.display=single?"none":"");nav&&(nav.style.display=single?"none":"");root.toggleAttribute("data-single",single)},titlesFor=car=>{const sel=car.getAttribute("data-titles");if(sel){const n=Array.from(D.querySelectorAll(sel));if(n.length)return n}const scope=car.closest(".card,.body,aside,section,div")||D;const t=Array.from(scope.querySelectorAll(".reel-title"));return t.length?t:null},initCar=(root,onChange)=>{const track=root.querySelector(".carousel-track");if(!track||root.dataset.cInit==="1")return;root.dataset.cInit="1";const prev=root.querySelector(".arrowCircle.prev"),next=root.querySelector(".arrowCircle.next"),slides=Array.from(track.querySelectorAll(":scope > .carousel-slide")),len=slides.length;let dots=syncDots(root,len);hide(root,len);if(len<=1){dots[0]&&dots[0].classList.add("active");onChange&&onChange(0);return}let i=0;const paint=idx=>dots.forEach((d,di)=>d.classList.toggle("active",di===idx)),set=(n,beh="smooth")=>{i=(n+len)%len;paint(i);track.scrollTo({left:track.clientWidth*i,behavior:beh});onChange&&onChange(i)};dots.forEach((d,idx)=>d.addEventListener("click",()=>{pause();set(idx)}));prev&&prev.addEventListener("click",()=>{pause();set(i-1)});next&&next.addEventListener("click",()=>{pause();set(i+1)});track.addEventListener("scroll",()=>{if(!track.clientWidth)return;const n=Math.round(track.scrollLeft/track.clientWidth);if(n!==i){i=Math.max(0,Math.min(len-1,n));paint(i);onChange&&onChange(i)}});W.addEventListener("resize",()=>set(i,"auto"));set(0,"auto")},boot=()=>{D.querySelectorAll(".carousel").forEach(car=>{const titles=titlesFor(car);initCar(car,idx=>{titles&&titles.forEach((t,k)=>t.classList.toggle("active",k===idx))})})};D.readyState==="loading"?D.addEventListener("DOMContentLoaded",boot,{once:!0}):boot()})();

/* =========================================================
   4) HARD RESET .carouselX .track (scrollLeft = 0)
   ========================================================= */
(()=>{const tracks=D.querySelectorAll(".carouselX .track");if(!tracks.length)return;const force=t=>{if(!t)return;const prev=t.style.scrollBehavior;t.style.scrollBehavior="auto";t.scrollLeft=0;requestAnimationFrame(()=>{t.scrollLeft=0});setTimeout(()=>{t.scrollLeft=0;t.style.scrollBehavior=prev||""},80)};tracks.forEach(force);try{"scrollRestoration"in history&&(history.scrollRestoration="manual")}catch{}W.addEventListener("pageshow",e=>{e.persisted&&tracks.forEach(force)});W.addEventListener("resize",()=>tracks.forEach(force))})();

/* =========================================================
   5) LIST SLIDER
   ========================================================= */
(()=>{D.querySelectorAll(".listSlider").forEach(w=>{const t=w.querySelector(".listTrack"),p=w.querySelector(".arrowCircle.prev"),n=w.querySelector(".arrowCircle.next");if(!t||!p||!n)return;let i=0,len=t.children.length;const go=x=>{W.pauseAllYTIframes&&W.pauseAllYTIframes();i=(x+len)%len;t.scrollTo({left:w.clientWidth*i,behavior:"smooth"})};p.addEventListener("click",()=>go(i-1));n.addEventListener("click",()=>go(i+1));W.addEventListener("resize",()=>go(i))})})();

/* =========================================================
   6) PÍLDORAS
   ========================================================= */
(()=>{const pills=[...D.querySelectorAll(".pill")],cards=[...D.querySelectorAll(".feature-grid .fcard")];if(!pills.length||!cards.length)return;const apply=tag=>cards.forEach(c=>{c.style.display=c.classList.contains("tag-"+tag)?"":"none"});pills.forEach(p=>p.addEventListener("click",()=>{pills.forEach(x=>x.classList.remove("active"));p.classList.add("active");apply(p.dataset.filter)}));apply(pills[0]?.dataset.filter||"nomina")})();

/* =========================================================
   7) FAQ (solo uno abierto)
   ========================================================= */
(()=>{const wrap=D.getElementById("faqWrap");if(!wrap)return;[...wrap.querySelectorAll(".faq-item")].forEach(it=>{it.addEventListener("toggle",()=>{if(it.open)[...wrap.querySelectorAll(".faq-item")].forEach(o=>{o!==it&&o.removeAttribute("open")})})})})();

/* =========================================================
   8) CAROUSEL SISTEMAS (.carouselX)
   ========================================================= */
(()=>{const ensureUI=root=>{let prev=root.querySelector(".arrowCircle.prev"),next=root.querySelector(".arrowCircle.next");prev||(prev=D.createElement("button"),prev.className="arrowCircle prev",prev.setAttribute("aria-label","Anterior"),prev.innerHTML='<span class="chev">‹</span>',root.appendChild(prev));next||(next=D.createElement("button"),next.className="arrowCircle next",next.setAttribute("aria-label","Siguiente"),next.innerHTML='<span class="chev">›</span>',root.appendChild(next));let dotsWrap=root.querySelector(".group-dots");dotsWrap||(dotsWrap=D.createElement("div"),dotsWrap.className="group-dots",root.appendChild(dotsWrap));return{prev,next,dotsWrap}};D.querySelectorAll(".carouselX").forEach(root=>{if(root.dataset.cxInit==="1")return;root.dataset.cxInit="1";const track=root.querySelector(".track");if(!track)return;const items=[...root.querySelectorAll(".sys")];items.forEach(it=>{it.setAttribute("role","link");it.setAttribute("tabindex","0");let touched=!1;const isMob=()=>W.matchMedia("(max-width: 768px)").matches,go=()=>{const href=it.getAttribute("data-href");href&&W.open(href,"_blank","noopener")};it.addEventListener("click",e=>{e.preventDefault();if(isMob()&&!touched){touched=!0;it.classList.add("show-hover");setTimeout(()=>{touched=!1},2000);return}go()});it.addEventListener("keydown",e=>{(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),go())})});const{prev,next,dotsWrap}=ensureUI(root),perView=()=>W.innerWidth<=980?1:3,viewportW=()=>track.clientWidth||root.clientWidth||1,pageCount=()=>Math.max(1,Math.ceil((track.scrollWidth-1)/viewportW()));let idx=0,dots=[];const build=()=>{dotsWrap.innerHTML="";const total=pageCount();dots=[...Array(total)].map((_,j)=>{const b=D.createElement("button");b.className="dot"+(j===0?" active":"");b.setAttribute("aria-label","Ir a página "+(j+1));b.addEventListener("click",()=>{W.pauseAllYTIframes&&W.pauseAllYTIframes();go(j)});dotsWrap.appendChild(b);return b})},paint=j=>dots.forEach((d,i)=>d.classList.toggle("active",i===j)),toggle=()=>{const multi=pageCount()>1;prev.style.display=multi?"":"none";next.style.display=multi?"":"none";dotsWrap.style.display=multi?"":"none"},go=j=>{const total=pageCount();idx=((j%total)+total)%total;const startIdx=Math.min(idx*perView(),items.length-1),first=items[startIdx];let baseLeft=idx===0?0:(first?first.offsetLeft-(track.firstElementChild?.offsetLeft||0):idx*viewportW());const maxLeft=Math.max(0,track.scrollWidth-viewportW());track.scrollTo({left:Math.min(Math.max(0,baseLeft),maxLeft),behavior:"smooth"});paint(idx);toggle()};build();prev.addEventListener("click",()=>{W.pauseAllYTIframes&&W.pauseAllYTIframes();go(idx-1)});next.addEventListener("click",()=>{W.pauseAllYTIframes&&W.pauseAllYTIframes();go(idx+1)});track.addEventListener("scroll",()=>{const i=Math.round(track.scrollLeft/viewportW());i!==idx&&(idx=i,paint(idx))});W.addEventListener("resize",()=>{const now=pageCount();dots.length!==now&&build();setTimeout(()=>go(idx),0)});const reset=()=>{track.scrollLeft=0;idx=0;paint(0);toggle()};requestAnimationFrame(reset);W.addEventListener("load",()=>setTimeout(reset,0));W.addEventListener("pageshow",reset);setTimeout(reset,350);track.style.overflowX="auto";track.style.scrollBehavior="smooth";toggle();go(0);setTimeout(()=>track.scrollTo({left:0,behavior:"auto"}),50)})})();

/* =========================================================
   10) CALCULADORA (tu bloque igual)
   ========================================================= */
(()=>{D.addEventListener("DOMContentLoaded",()=>{const app=D.getElementById("app"),PRIMARY=app?.dataset?.system?.trim();if(!PRIMARY)return;const moneyMX=new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN",maximumFractionDigits:0}),fmt=v=>moneyMX.format(Math.round(Number(v||0))),hasPrices=n=>!!(W.preciosContpaqi&&W.preciosContpaqi[n]);W.CATALOG_SISTEMAS=W.CATALOG_SISTEMAS||[{name:"CONTPAQi Contabilidad",img:"../IMG/contabilidadsq.webp"},{name:"CONTPAQi Bancos",img:"../IMG/bancossq.webp"},{name:"CONTPAQi Nóminas",img:"../IMG/nominassq.webp"},{name:"CONTPAQi XML en Línea",img:"../IMG/xmlsq.webp",noDiscount:!0},{name:"CONTPAQi Comercial PRO",img:"../IMG/comercialprosq.webp"},{name:"CONTPAQi Comercial PREMIUM",img:"../IMG/comercialpremiumsq.webp"},{name:"CONTPAQi Factura Electrónica",img:"../IMG/facturasq.webp"}];const getPrecioDesde=name=>{const db=(W.preciosContpaqi&&W.preciosContpaqi[name])||null;if(!db)return null;return db.anual?.MultiRFC?.precio_base||db.anual?.MultiRFC?.renovacion?Number(db.anual.MultiRFC.precio_base||db.anual.MultiRFC.renovacion||0):db.anual?.MonoRFC?.precio_base||db.anual?.MonoRFC?.renovacion?Number(db.anual.MonoRFC.precio_base||db.anual.MonoRFC.renovacion||0):db.tradicional?.actualizacion?.precio_base?Number(db.tradicional.actualizacion.precio_base):null},renderPicker=(id,exclude=new Set,active=null)=>{const wrap=D.getElementById(id);if(!wrap)return;wrap.innerHTML="";PRIMARY&&exclude.add(PRIMARY);W.CATALOG_SISTEMAS.forEach(item=>{if(exclude.has(item.name))return;const precio=getPrecioDesde(item.name),btn=D.createElement("button");btn.className="sys-icon";btn.type="button";btn.dataset.sys=item.name;btn.title=item.name;btn.innerHTML=`${item.noDiscount?'<small class="sin15">sin -15%</small>':""}<img src="${item.img}" alt="${item.name}"><strong>${item.name.replace("CONTPAQi ","")}</strong><small class="sys-price">${precio!=null?"desde "+fmt(precio):"precio no disp."}</small>`;active&&active===item.name&&btn.classList.add("active");wrap.appendChild(btn)})},renderCombined=rows=>{const wrap=D.getElementById("combined-wrap"),tbody=D.getElementById("combined-table-body");if(!wrap||!tbody)return;tbody.innerHTML="";rows.forEach(([c,imp])=>{const tr=D.createElement("tr"),td1=D.createElement("td"),td2=D.createElement("td");td1.textContent=c;td2.textContent=imp;td2.style.textAlign="right";tr.appendChild(td1);tr.appendChild(td2);tbody.appendChild(tr)});wrap.hidden=!1};const row=D.getElementById("calc-row"),slot2=D.getElementById("calc-slot-2")||D.getElementById("calc-secondary"),slot3=D.getElementById("calc-tertiary"),addMore=D.getElementById("add-more-panel"),pick2=D.getElementById("icons-sec-sys"),pick3=D.getElementById("icons-third-sys");if(!row)return;const selected={secondary:null,tertiary:null},setSel=()=>new Set([selected.secondary,selected.tertiary].filter(Boolean));renderPicker("icons-sec-sys",new Set([PRIMARY]));renderPicker("icons-third-sys",new Set([PRIMARY]));const refresh=()=>{const ex=setSel();PRIMARY&&ex.add(PRIMARY);renderPicker("icons-sec-sys",ex,selected.secondary);renderPicker("icons-third-sys",ex,selected.tertiary)},showMore=()=>{addMore&&(addMore.style.display=selected.secondary?"":"none")};pick2?.addEventListener("click",e=>{const btn=e.target.closest(".sys-icon");if(!btn)return;const sys=btn.dataset.sys;if(!hasPrices(sys))return;selected.secondary=sys;selected.tertiary=selected.tertiary===sys?null:selected.tertiary;slot2&&slot2.id==="calc-slot-2"&&(slot2.className="calc-container",slot2.id="calc-secondary");W.CalculadoraContpaqi?.setSecondarySystem&&W.CalculadoraContpaqi.setSecondarySystem(sys,{secondarySelector:"#calc-secondary",combinedSelector:"#combined-wrap",onCombined:renderCombined});refresh();showMore()});pick3?.addEventListener("click",e=>{const btn=e.target.closest(".sys-icon");if(!btn)return;const sys=btn.dataset.sys;if(!hasPrices(sys)||sys===selected.secondary)return;selected.tertiary=sys;slot3&&(slot3.style.display="block");W.CalculadoraContpaqi?.setTertiarySystem&&W.CalculadoraContpaqi.setTertiarySystem(sys,{tertiarySelector:"#calc-tertiary",combinedSelector:"#combined-wrap",onCombined:renderCombined});addMore&&(addMore.style.display="none");row.classList.add("has-three");refresh()});W.CalculadoraContpaqi?.onCombinedSet&&W.CalculadoraContpaqi.onCombinedSet(renderCombined);if(W.CalculadoraContpaqi?.init){D.body.setAttribute("data-calc","escritorio");W.CalculadoraContpaqi.init({systemName:PRIMARY,primarySelector:"#calc-primary",combinedSelector:"#combined-wrap"})}else console.warn("CalculadoraContpaqi.init no disponible")})})();

/* =========================================================
   11) COMPACTADOR (tu bloque igual)
   ========================================================= */
(()=>{const pickByLabel=(c,rx)=>{const labels=[...c.querySelectorAll("label")],lb=labels.find(l=>rx.test((l.textContent||"").trim().toLowerCase()));if(!lb)return null;return lb.closest(".field")||lb.closest(".row")||lb.closest(".instalacion-box")||lb.closest(".inst-wrap")||lb.parentElement},pickSelect=(c,arr)=>{for(const s of arr){const el=c.querySelector(s);if(el)return el}return null},unir=c=>{if(!c||c.querySelector(".inst-wrap .instalacion-box"))return;const inst=pickSelect(c,["select#instalacion",'select[name*="instal"]','select[data-field*="instal"]']),serv=pickSelect(c,["select#servicios","select#ervicios",'select[name*="servi"]','select[data-field*="servi"]']);if(!inst||!serv)return;if(inst.closest(".instalacion-box")||serv.closest(".instalacion-box"))return;let wrap=c.querySelector(".inst-wrap");wrap||(wrap=D.createElement("div"),wrap.className="inst-wrap",(inst.closest("form")||c.querySelector("form")||c).appendChild(wrap));const box=D.createElement("div");box.className="instalacion-box";const il=inst.labels&&inst.labels[0]?inst.labels[0]:null,sl=serv.labels&&serv.labels[0]?serv.labels[0]:null;il&&box.appendChild(il);box.appendChild(inst);sl&&box.appendChild(sl);box.appendChild(serv);wrap.appendChild(box);if(!wrap.querySelector(".inst-hint")){const h=D.createElement("small");h.className="inst-hint";h.textContent="Selecciona instalación y servicios en un solo paso.";wrap.appendChild(h)}},compact=c=>{if(!c||c.querySelector("form.calc-form"))return;if(c.querySelector(".controls-grid")){unir(c);return}const bLic=pickByLabel(c,/^licencia/),bTipo=pickByLabel(c,/^tipo/),bUsu=pickByLabel(c,/^usuarios?/);let bInst=c.querySelector(".inst-wrap")||pickByLabel(c,/instalaci/);if(!bInst){const any=c.querySelector('input[type="checkbox"]');bInst=any?(any.closest(".instalacion-box")||any.closest(".field")||any.parentElement):null}const blocks=[bLic,bTipo,bUsu,bInst].filter(Boolean);blocks.forEach(b=>b?.classList?.add("field"));if(!bLic||!bTipo||!bUsu||!bInst)return;const g=D.createElement("div");g.className="controls-grid";g.append(bLic,bTipo,bUsu,bInst);c.insertBefore(g,c.firstElementChild);unir(c)};const target=D.getElementById("calc-primary");if(!target)return;const run=()=>{const c=D.querySelector(".calc-container")||target;if(!c||c.querySelector("form.calc-form"))return;compact(c)};run();requestAnimationFrame(run);new MutationObserver(run).observe(target,{childList:!0,subtree:!0});W.addEventListener("calc-recompute",run);W.addEventListener("calc-render",run);setTimeout(run,500);setTimeout(run,1200)})();

/* =========================================================
   12) AUTODIAG (tu bloque igual)
   ========================================================= */
(()=>{const sels=[".carouselX .track",".icons-wrap"],found=sels.flatMap(s=>Array.from(D.querySelectorAll(s)));found.forEach((el,i)=>{const cs=getComputedStyle(el),name=el.className||el.id||`track#${i}`,warn=(m,v)=>console.warn(`⚠️ [${name}] ${m}`,v);el.scrollWidth<=el.clientWidth+2&&warn("No tiene scroll real",{scrollWidth:el.scrollWidth,clientWidth:el.clientWidth});((cs.scrollSnapType&&cs.scrollSnapType!=="none")||el.style.scrollSnapType)&&warn("scroll-snap-type activo",cs.scrollSnapType);cs.justifyContent.includes("center")&&warn("justify-content:center detectado",cs.justifyContent);cs.direction==="rtl"&&warn("direction:rtl detectado",cs.direction);const r=el.getBoundingClientRect(),probe=D.elementsFromPoint(r.left+10,r.top+r.height/2),block=probe.find(n=>n!==el&&!el.contains(n)&&getComputedStyle(n).pointerEvents!=="none");block&&warn("Elemento sobre la orilla izquierda",block);el.scrollLeft>5&&warn("scrollLeft inicial ≠ 0",el.scrollLeft);el._diagFix={noSnap:()=>{el.style.scrollSnapType="none";el.querySelectorAll("*").forEach(n=>n.style.scrollSnapAlign="none");console.log(`✅ Snap desactivado en ${name}`)},flexStart:()=>{el.style.justifyContent="flex-start";console.log(`✅ justify-content:flex-start aplicado en ${name}`)},forceLTR:()=>{el.style.direction="ltr";console.log(`✅ direction:ltr aplicado en ${name}`)},resetScroll:()=>{el.scrollTo({left:0,behavior:"auto"});console.log(`✅ scrollLeft restablecido en ${name}`)}}})})();

/* =========================================================
   13) TOC
   ========================================================= */
(()=>{const toc=D.getElementById("toc");if(!toc)return;const openBtn=D.getElementById("tocToggle")||toc.querySelector(".toc-toggle"),closeBtn=toc.querySelector(".toc-close"),links=toc.querySelectorAll("a[href^='#']"),OPEN="open",CLOSED="collapsed",open=()=>{toc.classList.remove(CLOSED);OPEN&&toc.classList.add(OPEN)},close=()=>{toc.classList.add(CLOSED);OPEN&&toc.classList.remove(OPEN)},toggle=()=>{toc.classList.contains(CLOSED)?open():close()};openBtn&&openBtn.addEventListener("click",e=>{e.preventDefault();toggle()});closeBtn&&closeBtn.addEventListener("click",e=>{e.preventDefault();close()});links.forEach(a=>a.addEventListener("click",close));D.addEventListener("keydown",e=>{e.key==="Escape"&&close()})})();

})(); 
